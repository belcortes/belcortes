<script >
<% if current_user %>
var questions = <%= @questions.to_json.html_safe %>;
var last_question = questions[questions.length - 1];
var current_score = <%= current_user.score %>
var subtopic_id = questions[0].subtopic_id
var subtopic = <%= @questions[0].subtopic.to_json.html_safe %>
var score_params = {
  id: <%= current_user.id %>,
  score_increment: 10,
  'subtopic_id': subtopic_id
}


// ==============GLOBAL HELPER FUNCTIONS ============

function update_points_on_DOM(data){
  current_score = data.score;
  $('#points').text(current_score);
  return current_score;
}

var user_answer = function(){
  return $('input').val();
}

function add_answer(data, button, question_id){
  // may get more than 1 answer back
  answers_array = data
  actual_answer = data[0].content
  //REFACTOR!!!!!!!!!!! 
  if (user_answer() === actual_answer.toString()){
    $(button).parent().next('.question').show();
    $(button).parent().hide();
    
    

    $.ajax ({
      type: 'POST',
      url: "/add_score",
      data: score_params,
      success: function(data){
        update_points_on_DOM(data);
      }
    });
    // $('#points').append(add_score_to_user(data))
    if (last_question.id === question_id){
      console.log('you are on the last question!')
      console.log('topic finished!')
      $.ajax({
        type:'POST',
        url: "/add_subtopic",
        data: score_params,
        success: function(data){
          $('.subtopic-id').append(data)
          // $('.subtopic').addClass('background')
          window.location.href = "/subjects";
        }
      })

    }
  } else {
    alert('Sorry, the answer is incorrect please try again')
  };
}

// =============== JQUERY FUNCTIONS ============

$.fn.bels_awesome_func = function(e){
  // e.preventDefault();
  
  // var user_answer = $('input').val();
  var question_id = this.parent().data('id')
  var actual_answer = " "
  var answers_array = []
  var button = this;
  
  

  console.log(question_id)
  $.ajax({
    type: "GET",
    // error: function(xhr, status, error){
    //   console.log(xhr, status, error);
    // },
    dataType: "JSON", 
    url: "/answers?question_id="+question_id,
    success: function(data){
      add_answer(data, button, question_id);
    }
  })
};
// ================= DOCUMENT READY ===================

$(function() {
  $('.button').on('click', function() {
    $(this).bels_awesome_func();
  });
  $('#points').append(current_score);
});
<% end %>
</script>